<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="iOS中Network Extension安全科学Tunnel应用(Swift5)"><meta name="keywords" content="iOS"><meta name="author" content="zlyBear"><meta name="copyright" content="zlyBear"><title>iOS中Network Extension安全科学Tunnel应用(Swift5) | zlyBear's Blog</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建工程"><span class="toc-number">1.</span> <span class="toc-text">创建工程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NEKit集成"><span class="toc-number">2.</span> <span class="toc-text">NEKit集成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建VXN-Manager"><span class="toc-number">3.</span> <span class="toc-text">创建VXN Manager</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置Network-Extension"><span class="toc-number">4.</span> <span class="toc-text">配置Network Extension</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#开启VXN"><span class="toc-number">5.</span> <span class="toc-text">开启VXN</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#VXN配置-IP、端口等"><span class="toc-number">6.</span> <span class="toc-text">VXN配置(IP、端口等)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#关于网络状态的改变"><span class="toc-number">7.</span> <span class="toc-text">关于网络状态的改变</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DemoUI"><span class="toc-number">8.</span> <span class="toc-text">DemoUI</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#The-End"><span class="toc-number">9.</span> <span class="toc-text">The End</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参考文档："><span class="toc-number">10.</span> <span class="toc-text">参考文档：</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">zlyBear</div><div class="author-info__description text-center">我在这里记录工作和生活</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">1</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">1</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">zlyBear's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="post-info"><div id="post-title">iOS中Network Extension安全科学Tunnel应用(Swift5)</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-04-23</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>本文简要介绍iOS中NetworkExtension在提供安全科学（双弯道）使用G高级搜索引擎、Y视频等App简单应用，同时使用了第三方库NEKit提供路由规则支持。</p>
<blockquote>
<p>Demo代码已适配swift5，点击<a href="https://github.com/zlyBear/BearFree/tree/master" target="_blank" rel="noopener">GitHub链接</a>查看。</p>
<p>Demo运行需要有开发者账号，修改bundle id，在自己的开发者账号进行注册。</p>
</blockquote>
<p>在创建应用之前我们需要安装<strong>NEProviderTargetTemplates.pkg</strong>，在xcode10.12之后苹果在xcode中删除了这个文件，为什么？可能和中国区被下架的那些VXN一样的原因吧。好在我们还可以从老版本的xcode中提取这个文件，链接在此<a href="https://pan.baidu.com/s/1p-HxTtJr64RbzSuE33tyYw" target="_blank" rel="noopener">点击下载</a> ，提取码：<strong>18ek</strong>，要低调，安装好后重启xcode。</p>
<h3 id="创建工程"><a href="#创建工程" class="headerlink" title="创建工程"></a>创建工程</h3><p>接下来我们开始创建工程，首先和创建普通App一样创建一个Project</p>
<p><img src="http://lyz0818.5166.info//20190422152501_ChhUeh_Screenshot.jpeg" alt="创建Project"></p>
<p>创建好后我们在当前Project中创建一个Target</p>
<p><img src="http://lyz0818.5166.info//20190422153925_NI6i8o_Screenshot.jpeg" alt></p>
<p>选择Network Extension，Next</p>
<p><img src="http://lyz0818.5166.info//20190422154532_PgKs21_Screenshot.jpeg" alt></p>
<p>语言选择swift，因为NEKit是swift写的，并且对oc支持不是很好，所以这里就用swift来写了。</p>
<p><img src="http://lyz0818.5166.info//20190422154651_9JICcO_Screenshot.jpeg" alt></p>
<p>创建好后，目录下会出现一个新的文件夹</p>
<p><img src="http://lyz0818.5166.info//20190422160544_sZl27o_Screenshot.jpeg" alt></p>
<p>有关代理的代码在PacketTunnelProvider.swift中编写。</p>
<p>在工程创建完毕后，需要在Target的Capabilities中开启Network Extensions和Personal VXN功能，注意项目本身主Target及PacketTunnel都需要开启这两项功能。</p>
<p><img src="http://lyz0818.5166.info//20190422161751_mpCKDy_Screenshot.jpeg" alt></p>
<p>好了，到此工程就创建好了。</p>
<h3 id="NEKit集成"><a href="#NEKit集成" class="headerlink" title="NEKit集成"></a>NEKit集成</h3><p>由于项目中使用的NEKit这个第三方库只支持Carthage进行集成管理，所以demo使用的集成工具也是Carthage，没有用过的可以自行Google，安装使用难度不高，一看即会。</p>
<p>但是<strong>注意</strong>在第三方库编译的时候需要使用NEKit提供的编译方式，直接carthage update项目无法运行。</p>
<blockquote>
<p><strong>carthage update –no-use-binaries –platform mac,ios</strong></p>
</blockquote>
<p>第三方库编译好后会在Carthage目录下Build/iOS中生成.framework文件，我们需要把这些framework添加到项目中去，下图的两个位置都要需要添加，与Net无关的包在packetTunnel中可以不需要添加。</p>
<p><img src="http://lyz0818.5166.info//20190422171252_Y994p5_Screenshot.jpeg" alt></p>
<p><img src="http://lyz0818.5166.info//img/20190422171706_L5Mzuo_Screenshot.png?markdown" alt></p>
<p>至此相关环境配置就已经搞定了，下面开始看代码如何建立VXN链接</p>
<h3 id="创建VXN-Manager"><a href="#创建VXN-Manager" class="headerlink" title="创建VXN Manager"></a>创建VXN Manager</h3><p>首先需要创建一个NETunnelProviderManager</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fileprivate</span> <span class="function"><span class="keyword">func</span> <span class="title">createProviderManager</span><span class="params">()</span></span> -&gt; <span class="type">NETunnelProviderManager</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> manager = <span class="type">NETunnelProviderManager</span>()</span><br><span class="line">    <span class="keyword">let</span> conf = <span class="type">NETunnelProviderProtocol</span>()</span><br><span class="line">    conf.serverAddress = <span class="string">"BearFree"</span></span><br><span class="line">    manager.protocolConfiguration = conf</span><br><span class="line">    manager.localizedDescription = <span class="string">"BearFree"</span></span><br><span class="line">    <span class="keyword">return</span> manager</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将manager保存至系统中</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">manager.saveToPreferences&#123;</span><br><span class="line">    error <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">if</span> error != <span class="literal">nil</span>&#123;<span class="built_in">print</span>(error);<span class="keyword">return</span>;&#125;</span><br><span class="line">        <span class="comment">//Todo</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行save方法后会跳转系统VXN菜单，添加我们创建的VPN</p>
<p><img src="http://lyz0818.5166.info//20190422201004_mlgeUD_Screenshot.jpeg" alt></p>
<p>此时如果save方法调用多次，会出现VPN 1 VPN 2等多个描述文件 ，因此，苹果也要求，在创建前应读取当前的managers</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">NETunnelProviderManager</span>.loadAllFromPreferencesWithCompletionHandler&#123; </span><br><span class="line">    (managers, error) <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> managers = managers <span class="keyword">else</span>&#123;<span class="keyword">return</span>&#125;</span><br><span class="line">    <span class="keyword">let</span> manager: <span class="type">NETunnelProviderManager</span></span><br><span class="line">    <span class="keyword">if</span> managers.<span class="built_in">count</span> &gt; <span class="number">0</span> &#123;</span><br><span class="line">        manager = managers[<span class="number">0</span>]</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        manager = <span class="keyword">self</span>.createProviderManager()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Todo</span></span><br><span class="line">    <span class="comment">// manager.saveToPreferences.......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="配置Network-Extension"><a href="#配置Network-Extension" class="headerlink" title="配置Network Extension"></a>配置Network Extension</h3><p>打开extension中的模板文件，对应Swift版本与父类修改语法。主要需要以下两个函数控制VPN状态</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//启动VPN时调用</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">startTunnel</span><span class="params">(options: [String : NSObject]?, completionHandler: @escaping <span class="params">(Error?)</span></span></span> -&gt; <span class="type">Void</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//停止VPN时调用</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">stopTunnel</span><span class="params">(with reason: NEProviderStopReason, completionHandler: @escaping <span class="params">()</span></span></span> -&gt; <span class="type">Void</span>)</span><br></pre></td></tr></table></figure>
<p>此时我们仅仅需要测试VPN连接是否能正常建立。因此我们只需要在startTunnelWithOptions中调用setTunnelNetworkSettings 方法即可。当completionHandler()执行后VPN连接就会显示在手机上了。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">startTunnel</span><span class="params">(options: [String : NSObject]?, completionHandler: @escaping <span class="params">(Error?)</span></span></span> -&gt; <span class="type">Void</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> ipv4Settings = <span class="type">NEIPv4Settings</span>(addresses: [<span class="string">"192.169.89.1"</span>], subnetMasks: [<span class="string">"255.255.255.0"</span>])</span><br><span class="line">    <span class="keyword">let</span> networkSettings = <span class="type">NEPacketTunnelNetworkSettings</span>(tunnelRemoteAddress: <span class="string">"8.8.8.8"</span>)</span><br><span class="line">    networkSettings.mtu = <span class="number">1500</span></span><br><span class="line">    networkSettings.iPv4Settings = ipv4Settings</span><br><span class="line">    setTunnelNetworkSettings(networkSettings) &#123;</span><br><span class="line">        error <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">guard</span> error == <span class="literal">nil</span> <span class="keyword">else</span> &#123;</span><br><span class="line">            completionHandler(error)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">            completionHandler(<span class="literal">nil</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="开启VXN"><a href="#开启VXN" class="headerlink" title="开启VXN"></a>开启VXN</h3><p>对刚刚创建的manager调用startVPNTunnel方法即可</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> manager.connection.startVPNTunnel(options: [:])</span><br></pre></td></tr></table></figure>
<p>如果在创建VXN saveToPreferences后立刻执行startVPNTunnel，此时可能会出现Domin=”null”，说明系统并未准备好，所以启动代码放至loadAndCreatePrividerManager方法的返回block中</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">connect</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">self</span>.loadAndCreatePrividerManager &#123; (manager) <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> manager = manager <span class="keyword">else</span>&#123;<span class="keyword">return</span>&#125;</span><br><span class="line">        <span class="keyword">do</span>&#123;</span><br><span class="line">            <span class="keyword">try</span> manager.connection.startVPNTunnel(options: [:])</span><br><span class="line">        &#125;<span class="keyword">catch</span> <span class="keyword">let</span> err&#123;</span><br><span class="line">            <span class="built_in">print</span>(err)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体的实现逻辑可以查看demo中vpnManager.swift文件。</p>
<p>连接成功后manager.connection.status会发生改变，所以我们需要监听status值，从而得知目前的vpn连接状态，用于更新UI显示。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">addVPNStatusObserver</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">guard</span> !observerAdded <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    loadProviderManager &#123; [<span class="keyword">unowned</span> <span class="keyword">self</span>] (manager) -&gt; <span class="type">Void</span> <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> manager = manager &#123;</span><br><span class="line">            <span class="keyword">self</span>.observerAdded = <span class="literal">true</span></span><br><span class="line">            <span class="type">NotificationCenter</span>.<span class="keyword">default</span>.addObserver(forName: <span class="type">NSNotification</span>.<span class="type">Name</span>.<span class="type">NEVPNStatusDidChange</span>, object: manager.connection, queue: <span class="type">OperationQueue</span>.main, using: &#123; [<span class="keyword">unowned</span> <span class="keyword">self</span>] (notification) -&gt; <span class="type">Void</span> <span class="keyword">in</span></span><br><span class="line">                <span class="keyword">self</span>.updateVPNStatus(manager)</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="VXN配置-IP、端口等"><a href="#VXN配置-IP、端口等" class="headerlink" title="VXN配置(IP、端口等)"></a>VXN配置(IP、端口等)</h3><p>manager通过protocolConfiguration的属性向Network Extension传递配置信息，在vpnManager中实现如下配置方法，并在启动vpn前调用即可</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fileprivate</span> <span class="function"><span class="keyword">func</span> <span class="title">setRulerConfig</span><span class="params">(<span class="number">_</span> manager:NETunnelProviderManager)</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> conf = [<span class="type">String</span>:<span class="type">AnyObject</span>]()</span><br><span class="line">    conf[<span class="string">"ss_address"</span>] = ip_address <span class="keyword">as</span> <span class="type">AnyObject?</span></span><br><span class="line">    conf[<span class="string">"ss_port"</span>] = port <span class="keyword">as</span> <span class="type">AnyObject?</span></span><br><span class="line">    conf[<span class="string">"ss_method"</span>] = algorithm <span class="keyword">as</span> <span class="type">AnyObject?</span> <span class="comment">// 大写 没有横杠 看Extension中的枚举类设定 否则引发fatal error</span></span><br><span class="line">    conf[<span class="string">"ss_password"</span>] = password <span class="keyword">as</span> <span class="type">AnyObject?</span></span><br><span class="line">    conf[<span class="string">"ymal_conf"</span>] = getRuleConf() <span class="keyword">as</span> <span class="type">AnyObject?</span></span><br><span class="line">    <span class="keyword">let</span> orignConf = manager.protocolConfiguration <span class="keyword">as</span>! <span class="type">NETunnelProviderProtocol</span></span><br><span class="line">    orignConf.providerConfiguration = conf</span><br><span class="line">    manager.protocolConfiguration = orignConf</span><br><span class="line">    <span class="built_in">print</span>(ip_address,port,algorithm,password)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在Extension中</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">var</span> protocolConfiguration: <span class="type">NEVPNProtocol</span> &#123; <span class="keyword">get</span> &#125;</span><br></pre></td></tr></table></figure>
<p>存入了上面写入的配置信息，我们可以直接读取。</p>
<h3 id="关于网络状态的改变"><a href="#关于网络状态的改变" class="headerlink" title="关于网络状态的改变"></a>关于网络状态的改变</h3><p>4G与wifi切换，这里确实有点坑，在里面绕了很久，一开始调试发现vxn是通的，但是过段时间就不能用了，删了重装也不行，无意中改了一个extension中的ip又好用了，换了网络环境又不能用了，百思不得其解，debug了半天也没找到问题，下面先说下怎么如何监听网络环境变化：</p>
<p>NEProvider 中存在属性<code>public var defaultPath: NWPath? { get }</code> 表明当前系统的网络请求路径。我们可以通过KVO监听<code>defaultPath</code>的改变。当<code>defaultPath</code>与之前状态发生改变，且<code>defaultPath.status == .Satisfied</code>时，我们可以认定系统网络进行了切换。此时我们需要重启VPN及重启代理服务器。</p>
<p>重连VPN方法非常简单，只需要再次调用StartVPN函数即可。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">observeValue</span><span class="params">(forKeyPath keyPath: String?, of object: <span class="keyword">Any</span>?, change: [NSKeyValueChangeKey : <span class="keyword">Any</span>]?, context: UnsafeMutableRawPointer?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> keyPath == <span class="string">"defaultPath"</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.defaultPath?.status == .satisfied &amp;&amp; <span class="keyword">self</span>.defaultPath != lastPath&#123;</span><br><span class="line">            <span class="keyword">if</span>(lastPath == <span class="literal">nil</span>)&#123;</span><br><span class="line">                lastPath = <span class="keyword">self</span>.defaultPath</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="type">NSLog</span>(<span class="string">"received network change notifcation"</span>)</span><br><span class="line">                <span class="type">DispatchQueue</span>.main.asyncAfter(deadline: .now() + <span class="number">1</span>) &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] <span class="keyword">in</span></span><br><span class="line">                <span class="comment">// 延迟1s确保系统就绪</span></span><br><span class="line">                    <span class="keyword">guard</span> <span class="keyword">let</span> strongSelf = <span class="keyword">self</span> <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">                    strongSelf.startTunnel(options: <span class="literal">nil</span>)&#123; <span class="number">_</span> <span class="keyword">in</span> &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            lastPath = defaultPath</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那如何在这个Network Extension中debug呢？我们用正常的debug方式，尝试在当前文件中加入断点，发现毫无反应，所以Tunnel的调试有着单独的调试方式，首先我们需要将主程序在设备上运行，然后通过Xcode-&gt;Debug-&gt;Attach To Process （有个列表加载过程，需要稍等一下）选择你的Tunnel名进行debug，<strong>debug过程中如果不手动关闭tunnel的调试模式，会出现vxn链接后秒断的情况，需要注意一下。</strong>下面再来说我是如何解决上面所说的切换网络时出现的问题，在系统设置中找到我们的App，将<strong>网络访问权限调整为WLAN与蜂窝移动网</strong>，至此再切换网络就没有之前的问题了，为了App在刚启动时就可以获取网络权限，我加了一个无用的网络请求，你也可以用自己的方式来获取权限。</p>
<p><img src="http://lyz0818.5166.info//20190423121036_XaOOXa_Screenshot.jpeg" alt></p>
<h3 id="DemoUI"><a href="#DemoUI" class="headerlink" title="DemoUI"></a>DemoUI</h3><p>UI层我直接使用了Eureka这个第三方框架，它是XLForm的swift版本，也是通过carthage集成，想了解的也可以看下demo。</p>
<h3 id="The-End"><a href="#The-End" class="headerlink" title="The End"></a>The End</h3><p>好了，我碰到的问题应该都讲清楚了，有问题可以和我交流，如果有不对的地方希望指正，3Q！</p>
<h3 id="参考文档："><a href="#参考文档：" class="headerlink" title="参考文档："></a>参考文档：</h3><p><a href="https://github.com/zhuhaow/NEKit" target="_blank" rel="noopener">NEKit</a></p>
<p><a href="https://www.jianshu.com/p/5ed93a8a1449" target="_blank" rel="noopener">初探iOS Network Extension</a> </p>
<p><a href="https://cloud.tencent.com/developer/article/1193619" target="_blank" rel="noopener">iOS开发实战-NetworkExtension</a></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">zlyBear</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://zlyBear.github.io/2019/04/23/2019-04-23/">http://zlyBear.github.io/2019/04/23/2019-04-23/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/iOS/">iOS</a></div><nav id="pagination"></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2019 By zlyBear</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script></body></html>